services:
  tts-service:
    build: .
    container_name: tts-service
    ports:
      - "4000:4000"
    volumes:
      - ./outputs:/app/outputs
      - ./temp_uploads:/app/temp_uploads
      - ./voice_gallery:/app/voice_gallery
      - ./voices_db.json:/app/voices_db.json
      - ./locutores_chile:/app/locutores_chile
    environment:
      - FLASK_PORT=4000
      - FLASK_DEBUG=false
      - GUNICORN_WORKERS=1
      - GUNICORN_THREADS=8
      - GUNICORN_TIMEOUT=600
      - COQUI_TOS_AGREED=1
      - PYTHONUNBUFFERED=1
      - ALLOWED_ORIGINS=http://localhost:3004,https://ai.cloudmusic.cl
      - FLASK_SECRET_KEY=production-secret-key-tts-service-2026
      - RATE_LIMIT_MAX_REQUESTS=5
      - RATE_LIMIT_WINDOW_SECONDS=86400
      - ALLOWED_FRONTEND_ORIGINS=https://ai.cloudmusic.cl,http://localhost:3004
      - REQUIRE_SIGNED_REQUESTS=true
      - SIGNATURE_ALGORITHM=ed25519
      - FRONTEND_KEY_ID=tts-frontend
      - FRONTEND_PUBLIC_KEY_PEM=
      - SIGNATURE_MAX_AGE_SECONDS=300
      - REQUIRE_TURNSTILE=false
      - TURNSTILE_SECRET_KEY=
      - REDIS_URL=redis://redis:6379/0
      - OUTPUT_DIR=outputs
      - TEMP_DIR=temp_uploads
      - VOICES_DIR=voice_gallery
      - VOICES_DB=voices_db.json
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    depends_on:
      - redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 16G
          cpus: '8'
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  redis:
    image: redis:7-alpine
    container_name: tts-redis
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    restart: unless-stopped
